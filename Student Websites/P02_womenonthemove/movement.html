<html>

<head>
    <title>Moving Through Riyadh</title>
    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.css " rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/landing-page.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <!--    <link href="http://cortnik.github.io/project/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
-->
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800'
        rel='stylesheet' type='text/css'>

    <script src="js/d3.v3.min.js" charset="utf-8"></script>
    <script src="js/topojson.min.js"></script>


    <!--    <script src="flow/data/roads.geojson"></script>
-->
    <script src="flow/data/PNOhotspots_total.json"></script>
    <script src="flow/data/PNDhotspot_total.json"></script>
    <!--    <script src="flow/geojsons/PNOedgeflow0607.geojson"></script>
    <script src="flow/geojsons/PNOedgeflow0708.geojson"></script>
    <script src="flow/geojsons/PNOedgeflow0809.geojson"></script>
    <script src="flow/geojsons/PNOedgeflow0910.geojson"></script>    
    <script src="flow/geojsons/PNOedgeflow1011.geojson"></script>
    <script src="flow/geojsons/PNOedgeflow1112.geojson"></script>
    <script src="flow/geojsons/PNOedgeflow1213.geojson"></script>
    <script src="flow/geojsons/PNOedgeflow1314.geojson"></script>
    <script src="flow/geojsons/PNOedgeflow1415.geojson"></script>
    <script src="flow/geojsons/PNOedgeflow1516.geojson"></script>
    <script src="flow/geojsons/PNOedgeflow1617.geojson"></script>
    <script src="flow/geojsons/PNOedgeflow1718.geojson"></script>
    <script src="flow/geojsons/PNOedgeflow1819.geojson"></script>
    <script src="flow/geojsons/PNOedgeflow1920.geojson"></script>   
    <script src="flow/geojsons/PNOedgeflow2021.geojson"></script>
    <script src="flow/geojsons/PNOedgeflow2122.geojson"></script>
    <script src="flow/geojsons/PNOedgeflow2223.geojson"></script>
    <script src="flow/geojsons/PNOedgeflow2324.geojson"></script>
    <script src="flow/geojsons/PNDedgeflow0607.geojson"></script>
    <script src="flow/geojsons/PNDedgeflow0708.geojson"></script>
    <script src="flow/geojsons/PNDedgeflow0809.geojson"></script>
    <script src="flow/geojsons/PNDedgeflow0910.geojson"></script>    
    <script src="flow/geojsons/PNDedgeflow1011.geojson"></script>
    <script src="flow/geojsons/PNDedgeflow1112.geojson"></script>
    <script src="flow/geojsons/PNDedgeflow1213.geojson"></script>
    <script src="flow/geojsons/PNDedgeflow1314.geojson"></script>
    <script src="flow/geojsons/PNDedgeflow1415.geojson"></script>
    <script src="flow/geojsons/PNDedgeflow1516.geojson"></script>
    <script src="flow/geojsons/PNDedgeflow1617.geojson"></script>
    <script src="flow/geojsons/PNDedgeflow1718.geojson"></script>
    <script src="flow/geojsons/PNDedgeflow1819.geojson"></script>
    <script src="flow/geojsons/PNDedgeflow1920.geojson"></script>   
    <script src="flow/geojsons/PNDedgeflow2021.geojson"></script>
    <script src="flow/geojsons/PNDedgeflow2122.geojson"></script>
    <script src="flow/geojsons/PNDedgeflow2223.geojson"></script>
    <script src="flow/geojsons/PNDedgeflow2324.geojson"></script>-->
    <script src="hotspot_data/metro.geojson"></script>
    <style>
    input[type=range] {
            -webkit-appearance: none;
            /* Hides the slider so that custom slider can be made */
            width: 100%;
            /* Specific width is required for Firefox. */
            background: transparent;
            /* Otherwise white in Chrome */
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
        }
        
        input[type=range]:focus {
            outline: none;
            /* Removes the blue border. You should probably do some kind of focus styling for accessibility reasons though. */
        }
        
        input[type=range]::-ms-track {
            width: 100%;
            cursor: pointer;
            /* Hides the slider so custom styles can be added */
            background: transparent;
            border-color: transparent;
            color: transparent;
        }
        /* Special styling for WebKit/Blink */
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            border: 1px solid #000000;
            height: 20px;
            width: 10px;
            border-radius: 30px;
            background: #ffffff;
            cursor: pointer;
            margin-top: -10px;
            /* You need to specify a margin in Chrome, but in Firefox and IE it is automatic */
            box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d;
            /* Add cool effects to your sliders! */
        }
        /* All the same stuff for Firefox */
        
        input[type=range]::-moz-range-thumb {
            box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d;
            border: 1px solid #000000;
            height: 20px;
            width: 10px;
            border-radius: 30px;
            background: #ffffff;
            cursor: pointer;
        }
        /* All the same stuff for IE */
        
        input[type=range]::-ms-thumb {
            box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d;
            border: 1px solid #000000;
            height: 20px;
            width: 10px;
            border-radius: 30px;
            background: #ffffff;
            cursor: pointer;
        }
        
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 1px;
            cursor: pointer;
            box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d;
            background: #000000;
            border-radius: 1.3px;
            border: 0.2px solid #010101;
            opacity:0.3;

        }
        
        input[type=range]:focus::-webkit-slider-runnable-track {
            background: #000000;
            opacity:0.3;

        }
        
        input[type=range]::-moz-range-track {
            width: 100%;
            height: 1px;
            cursor: pointer;
            box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d;
            background: #000000;
            border-radius: 1.3px;
            border: 0.2px solid #010101;
            opacity:0.3;

        }
        
        input[type=range]::-ms-track {
            width: 100%;
            height: 1px;
            cursor: pointer;
            background: transparent;
            border-color: transparent;
            border-width: 16px 0;
            color: transparent;

        }
        
        input[type=range]::-ms-fill-lower {
            background: #2a6495;
            border: 0.2px solid #010101;
            border-radius: 2.6px;
            box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d;

        }
        
        input[type=range]:focus::-ms-fill-lower {
            background: #000000;
        }
        
        input[type=range]::-ms-fill-upper {
            background: #000000;
            border: 0.2px solid #010101;
            border-radius: 2.6px;
            box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d;
        }
        
        input[type=range]:focus::-ms-fill-upper {
            background: #000000;
        }
        
        body {
            position: absolute;
            top: 30px;
            font-family: 'Open Sans', 'Helvetica Neue', Arial, sans-serif !important;
            /*background-color: #FFFAFA;
            color: #708090;*/
        }
        
        h3 {
            /*          position: absolute;
            left: 20px;*/
            font-size: 1.3em;
            font-weight: 100;
            /*color: #708090;*/
        }
        
        h2 {
            font-size: 1em;
            /* color: #708090;*/
        }
        
        .hotspot {
            stroke: none;
            fill: #2980b9;
            opacity: .7;
        }
        
        .hotspothover {
            stroke: none;
            fill: #2ecc71;
            opacity: .7;
        }
        
        .Paths {
            opacity: 1;
            fill: none;
            stroke: #f39c12;
            stroke-linecap: round;
        }
        
        #slider {
            width: 100%;
            height: 5px;
            float: left;
            margin-top:60px;
            /* position: absolute;    */
        }
        
        #slider > input[type=range] {
            width: calc(100% - 150px);
            margin-left: 100px;
            height: 20;
            display: block;
            position: relative;
            transform-origin: left;
            text-align: center;
        }
        
        #wrap {
            position:relative;
            width: 100%;
            height: 700px;
            margin-top: 30px;
            border: 1px solid rgba(0,0,0,0.1);
            background-color: rgba(0,0,0,0.03);
            padding-top:30px;
            margin-bottom: 30px;
        }
        
        span#range {
            position: absolute;
            left: 60px;
            bottom: 38px;
        }
        #origin_map {
            width: 49%;
            height: 550px;
            float: left;
            /* float:bottom; */
        }
        
        #destination_map {
            width: 49%;
            height: 550px;
            float: left;
        }

        .maps h5 {
            text-align:center;
        }

        .maps svg {
            width:100%;
            height:100%;
        }
    
    </style>
</head>

<body>

    <!-- Navigation -->

    <!-- /.container -->
    <div class="container">
        <br>
        <br>
        <h1 align="center"><strong>WHERE DO UNIVERSITY WOMEN TRAVEL IN RIYADH?</strong></h1>
        <br>
        <h3> Move the slider to animate the paths of commuters during each hour of a typical day. Orange lines represent the shortest
            paths between the Princess Noura campus and the commuter origin/destination hotspots. The size of the blue hotspots
            is based on the number of commuters flowing through each day. </h3>
    </div>
    </div>

    <div class="container">
        <div id="wrap">
            <div id="origin_map" class = "maps">
                <h5>COMMUTING FROM PRINCESS NOURA UNIVERSITY</h5>
                <h2_o></h2_o>
                <br>
            </div>



            <div id="destination_map" class = "maps">
                <h5>COMMUTING TO PRINCESS NOURA UNIVERSITY</h5>
                <h2_d></h2_d>
                <br>
            </div>
            <br>
            <div id="slider">

                <input id="timeslide" type="range" min="0" max="17" value="0" step="1" list="ticks"><br>
                <!--        <datalist id="ticks">
            <option>0</option>
            <option>1</option>
            <option>2</option>
            <option>3</option>
            <option>4</option>
            <option>5</option>
            <option>6</option>
            <option>7</option>
            <option>8</option>
            <option>9</option>
            <option>10</option>
            <option>11</option>
            <option>12</option>
            <option>13</option>
            <option>14</option>
            <option>15</option>
            <option>16</option>
            <option>17</option>
        </datalist><br>-->
                <span id="range">6:00</span>
            </div>
        </div>
        <div class="container">
            <p>
                <li>The visualizations show "hotspots of the origins/ destinations, the size of which represents the estimated
                    number of commuters that start, and end, at each location. </li>
                <li>These two complementary visualizations map out the hour-by-hour travel flows of the women university students
                    to and from the Princess Noura University, based on aggregated Call Detail Records (CDR).</li>

                <li>The visualizations show "hotspots of the origins/ destinations, the size of which represents the estimated
                    number of commuters that start, and end, at each location. </li>

                <li>A "shortest path" analysis was used to map out the approximate route that most commuters may choose. The
                    thickness of the lines represents the corresponding number of estimated commuters travelling towards
                    and from the University along those routes.</li>
            </p>
        </div>


        <script>
    d3.selection.prototype.moveToFront = function() {
    return this.each(function(){
        this.parentNode.appendChild(this);
    });
    };

    d3.selection.prototype.moveToBack = function() { 
        return this.each(function() { 
            var firstChild = this.parentNode.firstChild; 
            if (firstChild) { 
                this.parentNode.insertBefore(this, firstChild); 
            } 
        }); 
    };


    d3.json("flow/data/converted/roads_.geojson",function(roads){


        // var sliderContainer = d3.slider().min(0).max(17).ticks(16);
    var inputValue = null;
    var time = ["6:00","7:00","8:00","9:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00","24:00"];

    var width = 500;
    var height = 500;

    var origin_map = d3.select( "#origin_map" )
        .append("svg").moveToBack();
/*        .attr( "width", width )
        .attr( "height", height )*/;

    var g = origin_map.append( "g" );

    // Set Projection Parameters
    // Mercator
    var projection = d3.geo.mercator()
        .scale( 70000 )
        .center( [46.685, 24.763] )
        .translate( [width/2,height/2] );

    var geoPath = d3.geo.path()
        .projection( projection );

    var road_network = origin_map.append( "g" ).attr("class","road_network");
        road_network.selectAll( "path" )
        .data(topojson.feature(roads, roads.objects.roads_).features)


/*        .data( roads.features )
*/        .enter()
        .append( "path" )
        .attr("fill", "none")
        .attr( "stroke", "#d3d3d3" )
        .attr("opacity", .7)
        .attr("stroke-width", .1)
        .attr( "d", geoPath )
        .attr("class", "roads");

    var chosenhour_origin ;
    var enter_duration = 10
    
    var pnu = projection([46.723616, 24.852326])
    origin_map.append("circle")
    	.attr("cx", pnu[0])
    	.attr("cy", pnu[1])
    	.attr("r",4)
    	.style("fill", "#a11e1e");
    origin_map.append("circle")
    	.attr("cx", pnu[0])
    	.attr("cy", pnu[1])
    	.attr("r",8)
    	.style("fill", "none")
        .style("stroke-dasharray", "4 2")
        .style("stroke", "#a11e1e");

    var metroLines = origin_map.append( "g" ).attr("class","metroLines");
    metroLines.selectAll( "path" )
    .data(metro.features )
    .enter()
    .append( "path" )
    .attr("fill", "none")
    .attr( "stroke", "#828282" )
    .attr("stroke-width", .5)
    .attr( "d", geoPath )
    .attr("class", "metro");

    var PNO_routes = origin_map.append("g").attr("class","PNO_routes")
    var PNOhotspots_total = origin_map.append("g").attr("class","PNOhotspots_total");

    // when the input range changes update the value 
    d3.select("#timeslide").on("input", function() {
        update_pno(+this.value);
        update_pnd(+this.value);
    });

    // TIMESLIDER
        function update_pno(value) {
            document.getElementById("range").innerHTML=time[value];
            inputValue = time[value];
            var starttime = +(inputValue.replace(":00", ""));
            var endtime = starttime +1;
            var filename = "flow/geojsons/PNOedgeflow" + ("0" + starttime).slice(-2) + ("0" + endtime).slice(-2)+".geojson";

            d3.json(filename,function(chosenhour_origin){

                //chosenhour_origin = eval("PNOedgeflow" + String(inputValue.replace(":00", "")) + ".features");
                PNO_routes.selectAll("path").remove();
                PNO_routes.selectAll("path")
                .data(chosenhour_origin.features)//maybe can make this query from database api
                .enter()
                .append("path")
                .attr("stroke", "#000000")
                .transition()
                .delay(function (d,i){ 
                    return (d.properties.animation)* enter_duration;})
                .attr("stroke-width", function(d) {
                    var flow2 = Math.sqrt(+d.properties.flow);
                    return flow2;})
                .attr( "d", geoPath )
                .attr("class", "Paths")

                PNOhotspots_total.selectAll("circle").remove();

                PNOhotspots_total.selectAll("circle")
                    .data(hotspots_o.features)
                    .enter()
                    .append("circle")
                    .attr( "stroke", "#ffe28a" )
                    .attr("transform", function(d) {
                        return "translate(" + projection([+d.properties.long_dest,+d.properties.lat_dest]) + ")";
                    })
                    .attr("class", "hotspot")
                    .attr("r", 0)
                    .transition().delay(1100).duration(800)
                    .attr("r", function(d){return d.properties.flow*3;})
                    .attr("display", timeMatch);

                PNOhotspots_total.selectAll("circle")
                    .on("mouseover", function(d){
                        d3.select("h2_o").text("PERSON FLOW IN THIS HOUR: " + d.properties.flow);
                        d3.select(this).attr("class","hotspothover");
                    })
                    .on("mouseout", function(d){
                        d3.select("h2_o").text("");
                        d3.select(this).attr("class","hotspot");
                    });
                    


            })

    }

    var destination_map = d3.select( "#destination_map" )
        .append( "svg" ).moveToBack();
        /*
        .attr( "width", width )
        .attr( "height", height )*/;

    var g = destination_map.append( "g" );

    var road_network = destination_map.append( "g" ).attr("class","road_network");
        road_network.selectAll( "path" )
        .data(topojson.feature(roads, roads.objects.roads_).features)

/*        .data( roads.features )
*/        .enter()
        .append( "path" )
        .attr("fill", "none")
        .attr( "stroke", "#d3d3d3" )
        .attr("opacity", .7)
        .attr("stroke-width", .1)
        .attr( "d", geoPath )
        .attr("class", "roads");

    var chosenhour_dest;
    var enter_duration = 10
    
    var pnu1 = projection([46.723616, 24.852326]);

    destination_map.append("circle")
    .attr("cx", pnu[0])
    .attr("cy", pnu[1])
    .attr("r",4)
    .style("fill", "#a11e1e");

    destination_map.append("circle")
    	.attr("cx", pnu[0])
    	.attr("cy", pnu[1])
    	.attr("r",8)
    	.style("fill", "none")
        .style("stroke-dasharray", "4 2")
        .style("stroke", "#a11e1e");


     var metroLines = destination_map.append( "g" ).attr("class","metroLines");
        metroLines.selectAll( "path" )
        .data(metro.features )
        .enter()
        .append( "path" )
        .attr("fill", "none")
        .attr( "stroke", "#828282" )
        .attr("stroke-width", .5)
        .attr( "d", geoPath )
        .attr("class", "metro");

    var PND_routes = destination_map.append("g").attr("class","PND_routes");
    var PNDhotspots_total = destination_map.append("g").attr("class","PNDhotspots_total");


    // TIMESLIDER
        function update_pnd(value) {
            document.getElementById("range").innerHTML=time[value];
            inputValue = time[value];

            d3.selectAll(".hotspot")
            .attr("display", timeMatch);

            var starttime = +(inputValue.replace(":00", ""));
            var endtime = starttime +1;
            var filename = "flow/geojsons/PNDedgeflow" + ("0" + starttime).slice(-2) + ("0" + endtime).slice(-2)+".geojson";
            
            d3.json(filename,function(chosenhour_dest){
                //chosenhour_dest = eval("PNDedgeflow" + String(inputValue.replace(":00", "")) + ".features");

                PND_routes.selectAll("path").remove();
                PND_routes.selectAll( "path" )
                .data(chosenhour_dest.features)//maybe can make this query from database api
                .enter()
                .append("path")
                .attr("stroke", "#000000")
                .transition()
                .delay(function (d,i){ 
                    return (d.properties.animation)* enter_duration + 800;})
                .attr("stroke-width", function(d) {
                    var flow2 = Math.sqrt(+d.properties.flow);
                    return flow2;})
                .attr( "d", geoPath )
                .attr("class", "Paths");

                PNDhotspots_total.selectAll("circle").remove();
                PNDhotspots_total.selectAll("circle")
                .data(hotspots_d.features)
                .enter()
                .append("circle")
                .attr( "stroke", "#ffe28a" )
                .attr("transform", function(d) {
                    return "translate(" + projection([d.properties.long_origin, d.properties.lat_origin]) + ")";
                })
                .attr("class", "hotspot")
                .attr("r", 0)
                .transition().duration(800)
                .attr("r", function(d){return d.properties.flow*3;})
                .attr("display", timeMatch);

                PNDhotspots_total.selectAll("circle")
                .on("mouseover", function(d){
                    d3.select("h2_d").text("PERSON FLOW IN THIS HOUR: " + d.properties.flow);
                    d3.select(this).attr("class","hotspothover");
                })
                .on("mouseout", function(d){
                    d3.select("h2_d").text("");
                    d3.select(this).attr("class","hotspot");
                });



            });


    }

        update_pno(0);
        update_pnd(0);

            function timeMatch(data, value) {
                var d = data.properties.hour;
                var m = "9";
                if (inputValue == d) {
                    this.parentElement.appendChild(this);
                    return "display";
                } else {
                    return "none";
                };
            }
    });



</script>


    </div>
</body>

</html>